<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Book Library</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <h1>üìö My Book Library</h1>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="about.html" class="about-link">‚ÑπÔ∏è About This Application</a>
        </div>

        <!-- Auth Status Section -->
        <div id="auth-status" class="hidden">
            <span id="user-email"></span>
            <button id="logout-button" class="logout">Log Out</button>
        </div>

        <!-- Auth Container -->
        <div id="auth-container">
            <h2>Admin Login / Sign Up</h2>
            <form id="auth-form">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="button" id="login-button">Log In</button>
                <button type="button" id="signup-button">Sign Up</button>
            </form>
            <p id="auth-error" style="color: red;"></p>
        </div>

        <!-- Add Book Section -->
        <div id="add-book-section" class="hidden">
            <h2>Add a New Book</h2>
            
            <div class="add-book-methods-container">
                <!-- Manual Entry Section -->
                <div class="add-book-method">
                    <h3>üìù Manual Entry</h3>
                    <form id="addBookForm">
                        <div class="form-group">
                            <label for="bookName">Book Name:</label>
                            <div class="autocomplete-container">
                                <input type="text" id="bookName" placeholder="e.g., Dune" required>
                                <div id="bookName-autocomplete" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="authorName">Author:</label>
                            <div class="autocomplete-container">
                                <input type="text" id="authorName" placeholder="e.g., Frank Herbert" required>
                                <div id="authorName-autocomplete" class="autocomplete-dropdown"></div>
                            </div>
                        </div>
                        <button type="submit" class="add-book">‚ûï Add Book</button>
                    </form>
                </div>

                <!-- Divider -->
                <div class="method-divider">
                    <span>OR</span>
                </div>

                <!-- Scan Section -->
                <div class="add-book-method">
                    <h3>üì± Scan ISBN</h3>
                    <p class="method-description">Use your camera to scan a book's ISBN barcode or take a photo</p>
                    <button type="button" id="scan-isbn-button" class="scan-isbn">üì± Scan Book</button>
                </div>
            </div>
        </div>

        <!-- Edit Book Section -->
        <div id="edit-book-section" class="hidden">
            <h2>Edit Book</h2>
            <form id="editBookForm">
                <input type="hidden" id="editBookId">
                <div class="form-group">
                    <label for="editBookName">Book Name:</label>
                    <input type="text" id="editBookName" required>
                </div>
                <div class="form-group">
                    <label for="editAuthorName">Author:</label>
                    <input type="text" id="editAuthorName" required>
                </div>
                <button type="submit" id="saveEditButton">Save Changes</button>
                <button type="button" id="cancelEditButton" class="logout">Cancel</button>
            </form>
        </div>

        <!-- Collection Section -->
        <div class="search-section">
            <h2>Search in Library</h2>
            <input type="text" id="searchInput" placeholder="Search by name or author...">
        </div>
        <table id="bookTable">
            <thead>
                <tr>
                    <th data-column="title">Book Name</th>
                    <th data-column="author">Author</th>
                    <th id="actions-header" style="width: 120px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody id="bookList">
            </tbody>
        </table>
        
        <!-- Pagination Controls -->
        <div id="pagination-container" class="hidden">
            <div class="pagination-info">
                <span id="pagination-info-text"></span>
            </div>
            <div class="pagination-controls">
                <button id="first-page-button" class="pagination-button" title="First page">‚èÆÔ∏è</button>
                <button id="prev-page-button" class="pagination-button" title="Previous page">‚óÄÔ∏è</button>
                <span id="page-numbers"></span>
                <button id="next-page-button" class="pagination-button" title="Next page">‚ñ∂Ô∏è</button>
                <button id="last-page-button" class="pagination-button" title="Last page">‚è≠Ô∏è</button>
            </div>
        </div>
    </div>

    <!-- ISBN Scanner Modal -->
    <div id="isbn-scanner-modal" class="hidden">
        <div id="scanner-container">
            <h2>Add Book by ISBN</h2>

            <!-- Scanner Tabs -->
            <div class="scanner-tabs">
                <button class="scanner-tab active" data-mode="photo">üì∑ Photo Capture</button>
                <button class="scanner-tab" data-mode="barcode">üìä Barcode Scan</button>
                <button class="scanner-tab" data-mode="manual">‚úèÔ∏è Manual Input</button>
            </div>

            <!-- Photo Capture Mode (First Tab) -->
            <div id="photo-mode" class="scanner-mode active">
                <div id="photo-status"></div>
                <div id="invalid-isbn-input" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                    <p style="margin: 0 0 10px 0; font-size: 13px; color: #333;">The detected ISBN format appears invalid. You can edit it below:</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="invalid-isbn-field" placeholder="Enter or correct the ISBN" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <button type="button" id="invalid-isbn-retry-button" style="background-color: #27ae60; padding: 10px 15px; white-space: nowrap;">Search Again</button>
                    </div>
                </div>
                <div id="photo-preview-container" style="display: none; margin-bottom: 15px;">
                    <video id="video-photo" autoplay playsinline style="width: 100%; max-height: 400px; border-radius: 8px; object-fit: cover;"></video>
                </div>
                <canvas id="canvas" width="640" height="480"></canvas>
                <img id="photo-preview" alt="Preview" style="width: 100%; max-height: 400px; border-radius: 8px; display: none; margin-bottom: 15px;">
                
                <!-- Crop Modal -->
                <div id="crop-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 2000;">
                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow-y: auto;">
                        <h3 style="margin-top: 0;">Crop Photo</h3>
                        <p style="font-size: 12px; color: #666; margin: 5px 0 15px 0;">Drag handles or edges to adjust crop area ‚Ä¢ Drag center to move</p>
                        <div id="crop-container" style="position: relative; display: inline-block; max-height: 400px; overflow: hidden;">
                            <img id="crop-image" alt="Crop" style="max-height: 400px; width: auto; display: block;">
                            <div id="crop-overlay" style="position: absolute; border: 2px solid #3498db; cursor: move; background: rgba(52, 152, 219, 0.1);">
                                <div style="position: absolute; width: 10px; height: 10px; background: #3498db; border: 1px solid white; top: -5px; left: -5px; cursor: nwse-resize;" class="crop-handle" data-handle="nw"></div>
                                <div style="position: absolute; width: 10px; height: 10px; background: #3498db; border: 1px solid white; top: -5px; right: -5px; cursor: nesw-resize;" class="crop-handle" data-handle="ne"></div>
                                <div style="position: absolute; width: 10px; height: 10px; background: #3498db; border: 1px solid white; bottom: -5px; left: -5px; cursor: nesw-resize;" class="crop-handle" data-handle="sw"></div>
                                <div style="position: absolute; width: 10px; height: 10px; background: #3498db; border: 1px solid white; bottom: -5px; right: -5px; cursor: nwse-resize;" class="crop-handle" data-handle="se"></div>
                                <div style="position: absolute; width: 10px; background: #3498db; height: 2px; top: 0; left: 10px; right: 10px; cursor: ns-resize;" class="crop-edge" data-edge="top"></div>
                                <div style="position: absolute; width: 10px; background: #3498db; height: 2px; bottom: 0; left: 10px; right: 10px; cursor: ns-resize;" class="crop-edge" data-edge="bottom"></div>
                                <div style="position: absolute; width: 2px; background: #3498db; height: 10px; top: 10px; left: 0; bottom: 10px; cursor: ew-resize;" class="crop-edge" data-edge="left"></div>
                                <div style="position: absolute; width: 2px; background: #3498db; height: 10px; top: 10px; right: 0; bottom: 10px; cursor: ew-resize;" class="crop-edge" data-edge="right"></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button type="button" id="crop-confirm-button" style="background-color: #27ae60; flex: 1;">Confirm Crop</button>
                            <button type="button" id="crop-cancel-button" style="background-color: #e74c3c; flex: 1;">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div id="photo-buttons">
                    <button type="button" id="start-photo-button">‚ñ∂Ô∏è Start Photo Capture</button>
                    <button type="button" id="take-photo-button" class="hidden">üì∏ Take Photo</button>
                    <button type="button" id="crop-photo-button" class="hidden" style="background-color: #9b59b6;">‚úÇÔ∏è Crop Photo</button>
                    <button type="button" id="analyze-photo-button" class="hidden" style="background-color: #27ae60;">Analyze Photo</button>
                    <button type="button" id="retake-photo-button" class="hidden" style="background-color: #f39c12;">Retake Photo</button>
                </div>
                <button type="button" id="cancel-photo-button" class="logout" style="width: 100%; margin-top: 10px;">Cancel</button>
            </div>

            <!-- Barcode Scan Mode -->
            <div id="barcode-mode" class="scanner-mode">
                <div id="scanner-status"></div>
                <div id="barcode-preview" style="display: none; margin-bottom: 15px;">
                    <video id="video" autoplay playsinline style="width: 100%; max-height: 400px; border-radius: 8px; object-fit: cover;"></video>
                </div>
                <div id="scanner-buttons">
                    <button type="button" id="start-scanner-button">‚ñ∂Ô∏è Start Scanning</button>
                </div>
                <button type="button" id="cancel-scanner-button" class="logout" style="width: 100%; margin-top: 10px;">Cancel</button>
            </div>

            <!-- Manual Input Mode -->
            <div id="manual-mode" class="scanner-mode">
                <div id="manual-status">Ready to search. Enter ISBN manually or search by title.</div>
                <div class="isbn-input-group">
                    <input type="text" id="manual-isbn-input" placeholder="Enter ISBN (with or without hyphens)" autocomplete="off">
                    <button type="button" id="manual-isbn-submit" style="background-color: #27ae60;">Search</button>
                </div>
                <button type="button" id="cancel-manual-button" class="logout" style="width: 100%; margin-top: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <!-- Application Scripts -->
    <!-- Utility Modules (must load first) -->
    <script src="js/constants.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/status-manager.js"></script>
    <script src="js/camera-utils.js"></script>
    <script src="js/autocomplete.js"></script>
    
    <!-- Core Application Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/app-state.js"></script>
    <script src="js/dom-refs.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/book-library.js"></script>
    <script src="js/isbn-service.js"></script>
    <script src="js/barcode-scanner.js"></script>
    <script src="js/photo-capture.js"></script>
    <script src="js/photo-crop.js"></script>
    <script src="js/manual-isbn.js"></script>
    <script src="js/scanner-ui.js"></script>
    <script src="js/event-listeners.js"></script>
    <script src="js/app.js"></script>
</body>
</html>